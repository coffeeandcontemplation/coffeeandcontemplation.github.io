<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Coffee and Contemplation &middot; A developer blog
    
  </title>

  
  <link rel="canonical" href="http://localhost:4000/">
  

  <link rel="stylesheet" href="http://localhost:4000/public/css/poole.css">
  <link rel="stylesheet" href="http://localhost:4000/public/css/syntax.css">
  <link rel="stylesheet" href="http://localhost:4000/public/css/lanyon.css">
  <link rel="stylesheet" href="http://localhost:4000/public/css/tag.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" >

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="http://localhost:4000/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://localhost:4000/atom.xml">

  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FG8YL6SVEH"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-FG8YL6SVEH');
    </script>
  
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>A blog attempting to journal my learnings</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item active" href="http://localhost:4000/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="http://localhost:4000/about/">About</a>
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="http://localhost:4000/tag/">Tags</a>
        
      
    

    <span class="sidebar-nav-item">
        <a href="/atom.xml"><i class="fa fa-rss"></i> Feed</a>
    </div>

    <!--<a class="sidebar-nav-item" href="/archive/v1.1.0.zip">Download</a>-->
    <!--<span class="sidebar-nav-item">Currently v1.1.0</span>-->
  </nav>

  <!--<div class="sidebar-item">-->
    <!--<p>-->
      <!--&copy; 2022. All rights reserved.-->
    <!--</p>-->
  <!--</div>-->
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Coffee and Contemplation</a>
            <small>A developer blog</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:4000/2022/11/14/temp-logger-improvements-for-pi/">
        Temperature logger improvements
      </a>
    </h1>

  <span class="post-date">
    14 Nov 2022 |
    
        <a class="post-tag" href="http://localhost:4000/tag/#hacks"> hacks </a>
    
        <a class="post-tag" href="http://localhost:4000/tag/#raspberry"> raspberry </a>
    
        <a class="post-tag" href="http://localhost:4000/tag/#pi"> pi </a>
    
        <a class="post-tag" href="http://localhost:4000/tag/#pico"> pico </a>
    
  </span>

    [Part1](/2022/11/06/temperature-monitoring-with-rp-pico/)
[Part2](/2022/11/06/temperature-monitoring-with-rp-pico/)

The raspberry pi pico based temperature logger "hung" at times. It didn't write anything to the file at all. But, it wasn't obvious that it stopped working. Initially, I had plans to blink the onboard LED when writing to a file. But more experienced programmers suggested that `sensor_temp.read_u16()` is more likely to be the blocking call. So turning on the LED before reading the sensor and turning it off after would give a clear indication. The LED will remain on if the call is blocked.

```python
led = Pin(25, Pin.OUT)

def get_temperature():
    led.on()
    reading = sensor_temp.read_u16() * conversion_factor 
    temperature = 27 - (reading - 0.706)/0.001721
    led.off()
    return temperature
```

It looks like the pico has a [real time clock](https://docs.micropython.org/en/latest/library/machine.RTC.html?highlight=rtc#machine.RTC.datetime) and can be accessed with `machine.RTC()`. When running the code using Thonny, initializes the RTC with the current time. But when running outside of thonny, the RTC should get set to midnight of Jan 1, 2015. I'll write this time along with the temperature to get a sense of when(/if) the pico fails to write to the file.


```python
rtc=machine.RTC()
now = rtc.datetime()
file.write("{hh:02d}:{mm:02d}:{ss:02d}, {temperature:.2f}\n"
    .format(hh=now[4], mm=now[5], ss=now[6], temperature=temperature))
```

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:4000/2022/11/09/plotting-temp-timeseries/">
        Plotting a timeseries graph with gnuplot
      </a>
    </h1>

  <span class="post-date">
    09 Nov 2022 |
    
        <a class="post-tag" href="http://localhost:4000/tag/#hacks"> hacks </a>
    
        <a class="post-tag" href="http://localhost:4000/tag/#til"> TIL </a>
    
        <a class="post-tag" href="http://localhost:4000/tag/#gnuplot"> gnuplot </a>
    
        <a class="post-tag" href="http://localhost:4000/tag/#raspberry"> raspberry </a>
    
        <a class="post-tag" href="http://localhost:4000/tag/#pi"> pi </a>
    
        <a class="post-tag" href="http://localhost:4000/tag/#pico"> pico </a>
    
  </span>

    So, there was this [raspberry pi contraption](/2022/11/06/temperature-monitoring-with-rp-pico/) to log temperature to a file. The next step is to plot this in a graph. We get a single column file of recorded temperatures from the raspberry pi pico.

It is pretty easy to plot a graph from a two column file using gnuplot. If the filename is `temp_log`, all you need is:

```
plot 'temp_log' with lines
```

I was too lazy to find how to plot a single column file. The easy fix is to add another column with numbers. And that can be done easily with vim. You'd need to do the following keystrokes:

```
ctrl-v shift-g I 0 <space> <esc> - This will add a column of zeroes to the beginning

gv - This will reselect the column of zeroes

g ctrl-a - This will change the zeroes to an increasing sequence of numbers
```

[![asciicast](https://asciinema.org/a/IbCKMcPu0RY6p2RslQbBjd3wp.svg)](https://asciinema.org/a/IbCKMcPu0RY6p2RslQbBjd3wp)


Running `gnuplot -persist plot.plt` gets you the graph

![](/public/temp_graph.png "temperature graph")


### Shower thought
- Boards like these don't have a battery and can't keep real clock time. I have never thought of that before. It would have been easy if we could log the time along with the temperature.

### Next steps
- Blink an LED after writing to the file.
- Use `to_us_since_boot` from [the SDK](https://raspberrypi.github.io/pico-sdk-doxygen/group__timestamp.html) while logging temperature.

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:4000/2022/11/06/temperature-monitoring-with-rp-pico/">
        Temperature monitoring with raspberry pi
      </a>
    </h1>

  <span class="post-date">
    06 Nov 2022 |
    
        <a class="post-tag" href="http://localhost:4000/tag/#contemplation"> contemplation </a>
    
        <a class="post-tag" href="http://localhost:4000/tag/#hacks"> hacks </a>
    
        <a class="post-tag" href="http://localhost:4000/tag/#til"> TIL </a>
    
  </span>

    We bought a new Air conditioner for the house. It doesn't feel like the AC is able to regulate the temperature to what we set. But, humans are often wrong about these kind of things. A simple thermometer would have done the trick - but we need time-series temperature data to verify the AC function.

Enter - the [Raspberry pi pico](https://www.raspberrypi.com/documentation/microcontrollers/raspberry-pi-pico.html). It has a built-in ambient temperature sensor and supports micropython. It also has 2MB of storage. So, logging the temperature to a file should be easy.

*This is the "finished" project:*
![](/public/pico.jpg "finished project")

The OLED screen displays the latest temperature reading. Interfacing with the display was very easy. Tom's hardware has a [very good guide](https://www.tomshardware.com/how-to/oled-display-raspberry-pi-pico) explaining this. [Reading the temperature](https://how2electronics.com/read-temperature-sensor-value-from-raspberry-pi-pico/) was trivial too.

The dirty code I put together looked like this

```python
import machine
import utime
from machine import Pin, I2C
from ssd1306 import SSD1306_I2C

i2c=I2C(0,sda=Pin(0), scl=Pin(1), freq=400000)
oled = SSD1306_I2C(128, 64, i2c)
 
sensor_temp = machine.ADC(4)
conversion_factor = 3.3 / (65535)

file = open("temp_log.csv","a")

def get_temperature():
    reading = sensor_temp.read_u16() * conversion_factor 
    temperature = 27 - (reading - 0.706)/0.001721
    return temperature

while True:
    temperature = get_temperature()
    print(temperature)
    oled.fill(0)
    oled.text("Temp: %.2f" % temperature, 10, 10)
    oled.show()
    file.write("%.2f\n" % temperature)
    file.flush()
    utime.sleep(20)
```

The code worked most of the time. But, there were instances when the temperature reading just wouldn't change. Also, nothing was written to the file. Some debugging is required to find and fix the issue.

### Random learnings
- If you name the file as `main.py`, it will run when the pico is powered on.
- `"%0.2f"` will convert a float to a string and round off to 2 decimal places.
- A power bank is good enough to power the pico away from other power sources.

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:4000/2021/01/14/autocomplete-in-neovim/">
        Autocomplete in neovim with built-in LSP client
      </a>
    </h1>

  <span class="post-date">
    14 Jan 2021 |
    
        <a class="post-tag" href="http://localhost:4000/tag/#neovim"> neovim </a>
    
        <a class="post-tag" href="http://localhost:4000/tag/#plugin"> plugin </a>
    
        <a class="post-tag" href="http://localhost:4000/tag/#lsp"> lsp </a>
    
  </span>

    In the [last blog post](/2021/01/10/language-server-in-vim/), we saw how to setup the built-in lsp client in neovim for diagnostics and such. Now we'll see how to setup autocomplete.

First, install `completion-nvim`. Add this to your `vimrc` and run `PlugInstall`.

```vim
Plug 'nvim-lua/completion-nvim'
```

Now, in the `lsp_config.lua` file, you need to make some changes. The file should look like this:

```lua
lspconfig = require'lspconfig'
completion_callback = require'completion'.on_attach

lspconfig.pyls.setup{on_attach=completion_callback}
lspconfig.tsserver.setup{on_attach=completion_callback}
lspconfig.rust_analyzer.setup{on_attach=completion_callback}
```

This should give you completion. Now, we need a trigger to activate completion. I like the `tab` key. The config for this is available in the repo.

```vim
" Use <Tab> and <S-Tab> to navigate through popup menu
inoremap <expr> <Tab>   pumvisible() ? "\<C-n>" : "\<Tab>"
inoremap <expr> <S-Tab> pumvisible() ? "\<C-p>" : "\<S-Tab>"

" Set completeopt to have a better completion experience
set completeopt=menuone,noinsert,noselect

" Avoid showing message extra message when using completion
set shortmess+=c

let g:completion_enable_auto_popup = 0
imap <tab> <Plug>(completion_smart_tab)
imap <s-tab> <Plug>(completion_smart_s_tab)
```

Now, you can use `tab` and `shift + tab` to navigate through suggestions.

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:4000/2021/01/10/language-server-in-vim/">
        Language Server Client in neovim
      </a>
    </h1>

  <span class="post-date">
    10 Jan 2021 |
    
        <a class="post-tag" href="http://localhost:4000/tag/#neovim"> neovim </a>
    
        <a class="post-tag" href="http://localhost:4000/tag/#plugin"> plugin </a>
    
        <a class="post-tag" href="http://localhost:4000/tag/#lsp"> lsp </a>
    
  </span>

    ## What is language server protocol?

Development becomes a lot easier if all languages support features like autocomplete, linting, go-to-definition etc. within the editor of your choice. But this is a difficult task for editor devs. Each editor has to build support or integrate with tools that provide language support. Each of these tools behave in different ways making integration difficult. Language server protocol was defined by microsoft to put and end to this. LSP defines a standard protocol for tools(called language servers) to communicate with your editor.

![Why lsp](https://code.visualstudio.com/assets/api/language-extensions/language-server-extension-guide/lsp-languages-editors.png "Why lsp?")
*Image source: [Visual Studio Code](https://code.visualstudio.com/api/language-extensions/language-server-extension-guide)*

## What is a language server client?

A language server client is the part of your editor that interacts with a language server - Sometimes implemented as plugins, sometimes built-in.

## What language clients are available for vim?

1. [vim-lsp](https://github.com/prabirshrestha/vim-lsp)
1. [LanguageClient-neovim](https://github.com/autozimu/LanguageClient-neovim)
1. [coc.nvim](https://github.com/neoclide/coc.nvim)
1. [ale](https://github.com/dense-analysis/ale)
1. Built-in language server in [neovim](https://neovim.io/doc/user/lsp.html)

We'll see how to setup the built-in language server in neovim in this blog post.

## First, setup a decent looking theme

[Onebuddy](https://github.com/Th3Whit3Wolf/onebuddy) is an atom one inspired theme. [Install](/2020/11/07/vimming-in-2020/) the theme with `vim-plug`.
Add this to your vimrc:

```vim
Plug 'tjdevries/colorbuddy.vim'
Plug 'Th3Whit3Wolf/onebuddy', { 'branch': 'main' }
```

Enable the theme by adding this to vimrc:

```vim
set termguicolors
colorscheme onebuddy
```

## What features should we expect?

1. Show errors in line
1. Show warnings in line
1. Show errors/warnings in a list
1. Format file
1. Jump to definition
1. See documentation
1. Code actions - Actions like *"Extract to function", "Import this module"* - Yes, you can get that in vim.
1. Autocomplete

The first 7 are really easy to achieve. Let us handle autocomplete in a separate post.

## How to setup built-in lsp client for neovim?

neovim's lsp client is built in lua. The configuration is also in lua. Usable configurations for common language servers are collected in [neovim/nvim-lspconfig](https://github.com/neovim/nvim-lspconfig/blob/master/CONFIG.md).

Install the plugin with:

```vim
Plug 'neovim/nvim-lspconfig'
```

Let us create a new file in `.vim` directory with all the lsp configurations. Name it `lsp_config.lua`. Now in your `vimrc`, add the following:

```vimrc
luafile ~/.vim/lsp_config.lua
```

In this file, add some configuration for common language servers

```lua
lspconfig = require'lspconfig'

lspconfig.pyls.setup{}
lspconfig.tsserver.setup{}
lspconfig.rust_analyzer.setup{}
```

That is it! You should start seeing diagnostics now. Ensure you have the right language servers installed.
For example, for python language server, do

```bash
pip3 install 'python-language-server[all]'
```

## Add some signs to the gutter

It would be nice to see some symbols to the left of the code when there are errors.
Add these lines to your vimrc.

```vim
sign define LspDiagnosticsSignError text=🔴
sign define LspDiagnosticsSignWarning text=🟠
sign define LspDiagnosticsSignInformation text=🔵
sign define LspDiagnosticsSignHint text=🟢
```

## Add some keybindings

We need some keybindings for actions like **jump to definition**. Add the following to your vimrc.

```vim
nnoremap <silent> gd    <cmd>lua vim.lsp.buf.definition()<CR>
nnoremap <silent> gi    <cmd>lua vim.lsp.buf.implementation()<CR>
nnoremap <silent> gr    <cmd>lua vim.lsp.buf.references()<CR>
nnoremap <silent> gD    <cmd>lua vim.lsp.buf.declaration()<CR>
nnoremap <silent> ge    <cmd>lua vim.lsp.diagnostic.set_loclist()<CR>
nnoremap <silent> K     <cmd>lua vim.lsp.buf.hover()<CR>
nnoremap <silent> <leader>f    <cmd>lua vim.lsp.buf.formatting()<CR>
nnoremap <silent> <leader>rn    <cmd>lua vim.lsp.buf.rename()<CR>

nnoremap <silent> <leader>a <cmd>lua vim.lsp.buf.code_action()<CR>
xmap <silent> <leader>a <cmd>lua vim.lsp.buf.range_code_action()<CR>
```

This will create the following mappings

| Keybindings  | Action                                              |
| :----------- | -----------                                         |
| `gd`         | Go to definition                                    |
| `gi`         | Go to implementation                                |
| `gr`         | See references                                      |
| `gD`         | Go to declaration                                   |
| `ge`         | Show errors in loclist                              |
| `gd`         | Go to definition                                    |
| `space f`    | FOrmat file                                         |
| `space r n`  | Rename variable under cursor                        |
| `space a`    | Code actions - On normal mode and visual selections |

Your end result should look like this:
![lsp screenshot](/public/lsp_python.png "Screenshot of lsp python")


  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="http://localhost:4000/page2">Older</a>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script src='/public/js/script.js'></script>
  </body>
</html>
